name: CI Build LedFx (Apple Silicon)

on:
  workflow_dispatch:

jobs:

  build-ledfx-osx:
    name: Build LedFx (OS X) (Apple Silicon)
    runs-on: osx-arm64
    defaults:
      run:
        shell: bash -x {0}
    strategy:
      matrix:
        python: [3.12.x]
    steps:
      - name: Install build dependencies
        run: |
          arch -arm64 brew install portaudio
          arch -arm64 brew install mbedtls@2
          arch -arm64 brew install libsamplerate
          arch -arm64 brew install poetry
      - name: Setup mbedtls path
        run: |
          echo "/opt/homebrew/opt/mbedtls@2/bin" >> $GITHUB_PATH
      - name: Check Python version
        run: |
          arch -arm64 poetry --version
      - name: Check out code from GitHub
        uses: actions/checkout@v4
        with:
          repository: LedFx/LedFx
          ref: main
          fetch-depth: 0
      - name: Configure poetry
        run: |
          arch -arm64 poetry config virtualenvs.in-project true
          arch -arm64 poetry env info

      - name: Check lock file
        run: arch -arm64 poetry check --lock

      - name: Build a binary wheel
        run: |
          arch -arm64 poetry build

      - name: Install LedFx
        run: |
          arch -arm64 poetry install

      - name: Check version
        run: |
          arch -arm64 poetry run ledfx --version

      - name: Smoketest LedFx
        run: |
          arch -arm64 poetry run ledfx -vv --ci-smoke-test
      #    arch -arm64 python3 -V
      # - name: Build LedFx wheel
      #   run: |
      #     poetry build
      # - name: Install LedFx from wheel
      #   run: |
      #     export LDFLAGS="-L/opt/homebrew/opt/mbedtls@2/lib"
      #     export CPPFLAGS="-I/opt/homebrew/opt/mbedtls@2/include"
      #     poetry install
      # - name: Smoketest LedFx
      #   run: |
      #     source $(poetry env info -p)/bin/activate
      #     ledfx --ci-smoke-test
      #     if [ $? -ne 0 ]; then
      #       echo "LedFx launch failed: $?"
      #       exit 1
      #     fi
