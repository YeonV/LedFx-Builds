name: LedFx BuildPipeline Android Matrix

on:
  workflow_dispatch:
     inputs:
      fversion:
        description: 'Frontend Version'
        default: '109-b22'
        required: false
      upload_url:
        description: 'Upload URL for release'
        required: false
      release:
        description: 'Create Release'
        default: 'Yes'
        required: false
        type: choice
        options:
          - 'Yes'
          - 'No'
      ledfx_core_repo:
        description: 'LedFx Core repository'
        default: 'LedFx/LedFx'
        required: true
      ledfx_core_ref:
        description: 'LedFx Core branch, tag, or commit SHA'
        default: 'main'
        required: true
jobs:
  build_apks:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false # Allows other builds to continue even if one arch fails
      matrix:
        # Define the architectures you want to build for
        arch: [armeabi-v7a, arm64-v8a, x86, x86_64, universal]

    steps:
      - name: Checkout Android Builder
        uses: actions/checkout@v4
        with:
          repository: YeonV/ledfx-android
      - name: Checkout LedFx Core (Repo ${{ github.event.inputs.ledfx_core_repo }}, Ref ${{ github.event.inputs.ledfx_core_ref }})
        uses: actions/checkout@v4
        with:
          repository:  ${{ github.event.inputs.ledfx_core_repo }}
          path: deps/ledfx
          ref: ${{ github.event.inputs.ledfx_core_ref }}
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: YeonV/LedFx-Frontend-v2
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src3
      - name: Check out tools from GitHub
        uses: actions/checkout@v4
        with:
          repository: YeonV/LedFx-Builds
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src2

      - name: Delete old frontend
        uses: JesseTG/rm@2fb8f3b8a0e41fc222e7943b63306c602feb187e
        with:
          path: ./deps/ledfx/ledfx_frontend

      - name: apply patches
        run: |
          cp ./src2/tools/sentry.patch ./deps/ledfx/sentry.patch
          cd ./deps/ledfx
          git apply sentry.patch
          cd ../..

      - name: Prepare version Bump for Android
        id: prepare_version
        run: |
          raw_fversion="${{ github.event.inputs.fversion }}"
          patch_base=$(echo "$raw_fversion" | cut -d'-' -f1)
          beta_number_full=$(echo "$raw_fversion" | cut -d'-' -f2)
          beta_number=$(echo "$beta_number_full" | sed 's/b//')
          padded_beta_number=$(printf "%03d" "$beta_number")
          android_numeric_patch_part="${patch_base}${padded_beta_number}"
          echo "android_fversion_for_consts=$android_numeric_patch_part" >> $GITHUB_OUTPUT

      - name: Bump version to ${{ github.event.inputs.fversion }}
        continue-on-error: true
        run: |
          sed -i '0,/PROJECT_VERSION = "\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)\(-[a-z0-9]*\)*"/s//PROJECT_VERSION = "\1.\2.${{ steps.prepare_version.outputs.android_fversion_for_consts }}"/' ./deps/ledfx/ledfx/consts.py
          new_version=$(sed -n 's/.*PROJECT_VERSION = "\([0-9]*\.[0-9]*\.[0-9]*\(-[a-z0-9]*\)*\)".*/\1/p' ./deps/ledfx/ledfx/consts.py)
          echo "action_state=$new_version" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Build frontend
        run: |
          cd src3
          yarn
          yarn buildandroid
          cd ..

      - name: Include new build frontend
        run: |
          cp -r ./src3/build ./deps/ledfx/ledfx_frontend
          ls ./deps/ledfx/ledfx_frontend

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          architecture: x64
          python-version: 3.12

      - name: Setup Java 17 required by Gradle
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install and upgrade dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip autoconf automake libtool pkg-config zlib1g-dev \
            libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade git+https://github.com/kivy/buildozer

      - name: Clean previous Buildozer and P4A artifacts
        run: buildozer distclean || echo "distclean failed, continuing..."
        continue-on-error: true

      # --- KEY CHANGE: Configure Buildozer for the specific architecture ---
      - name: Configure Build Architecture for ${{ matrix.arch }}
        run: |
          if [[ "${{ matrix.arch }}" == "universal" ]]; then
            echo "Setting build for universal APK (all archs)"
            echo "BUILDOZER_OVERRIDE_APP_ANDROID_ARCHS=armeabi-v7a,arm64-v8a,x86,x86_64" >> $GITHUB_ENV
          else
            echo "Setting build for single arch: ${{ matrix.arch }}"
            echo "BUILDOZER_OVERRIDE_APP_ANDROID_ARCHS=${{ matrix.arch }}" >> $GITHUB_ENV
          fi

      - name: Build with Buildozer
        run: buildozer android debug

      # --- KEY CHANGE: Upload a uniquely named artifact for each architecture ---
      - name: Upload artifact for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.arch }}
          path: ./bin/*.apk

  release:
    if: ${{ github.event.inputs.release == 'Yes' && github.event.inputs.upload_url != '' }}
    runs-on: ubuntu-22.04
    needs: build_apks # Wait for all matrix builds to complete
    permissions:
      contents: write
    steps:
      # --- KEY CHANGE: Download all artifacts from the build jobs ---
      - name: Download all APK artifacts
        uses: actions/download-artifact@v4
        with:
          path: apks/
          # The pattern will match all artifacts starting with 'package-'
          pattern: package-*
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Listing all downloaded APKs:"
          ls -R apks/

      # --- KEY CHANGE: Loop through artifacts and upload each one ---
      - name: Upload all APKs to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for apk_file in apks/*.apk; do
            if [ -f "$apk_file" ]; then
              # Extract the architecture from the original artifact name (which became the filename)
              # e.g., 'ledfx-2.1.109-b22-armeabi-v7a-debug.apk' -> 'armeabi-v7a'
              # Note: buildozer names the file with arch, so we can parse it
              arch=$(echo "$(basename "$apk_file")" | sed -n 's/.*-\(armeabi-v7a\|arm64-v8a\|x86_64\|x86\)-.*/\1/p')

              # If arch isn't in the filename (e.g., the universal build), default to 'universal'
              if [ -z "$arch" ]; then
                arch="universal"
              fi

              asset_name="LedFx_CC-v2.1.${{ github.event.inputs.fversion }}--android-${arch}.apk"
              echo "Uploading $apk_file as $asset_name"

              gh release upload \
                --clobber \
                --repo ${{ github.repository }} \
                "${{ github.event.inputs.upload_url }}" \
                "$apk_file#$asset_name"
            fi
          done