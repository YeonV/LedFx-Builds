name: LedFx BuildPipeline Android Matrix

on:
  workflow_dispatch:
     inputs:
      fversion:
        description: 'Frontend Version'
        default: '109-b22'
        required: false
      upload_url:
        description: 'Upload URL for release'
        required: false
      release:
        description: 'Create Release'
        default: 'Yes'
        required: false
        type: choice
        options:
          - 'Yes'
          - 'No'
      ledfx_core_repo:
        description: 'LedFx Core repository'
        default: 'LedFx/LedFx'
        required: true
      ledfx_core_ref:
        description: 'LedFx Core branch, tag, or commit SHA'
        default: 'main'
        required: true
jobs:
  build_archs:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [armeabi-v7a, arm64-v8a, x86, x86_64]

    steps:
      - name: Checkout Android Builder
        uses: actions/checkout@v4
        with:
          repository: YeonV/ledfx-android
      - name: Checkout LedFx Core
        uses: actions/checkout@v4
        with:
          repository:  ${{ github.event.inputs.ledfx_core_repo }}
          path: deps/ledfx
          ref: ${{ github.event.inputs.ledfx_core_ref }}
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: YeonV/LedFx-Frontend-v2
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src3
      - name: Check out tools from GitHub
        uses: actions/checkout@v4
        with:
          repository: YeonV/LedFx-Builds
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src2

      - name: Delete old frontend
        uses: JesseTG/rm@2fb8f3b8a0e41fc222e7943b63306c602feb187e
        with:
          path: ./deps/ledfx/ledfx_frontend

      - name: apply patches
        run: |
          cp ./src2/tools/sentry.patch ./deps/ledfx/sentry.patch
          cd ./deps/ledfx
          git apply sentry.patch
          cd ../..

      - name: Prepare version Bump for Android
        id: prepare_version
        run: |
          raw_fversion="${{ github.event.inputs.fversion }}"
          patch_base=$(echo "$raw_fversion" | cut -d'-' -f1)
          beta_number_full=$(echo "$raw_fversion" | cut -d'-' -f2)
          beta_number=$(echo "$beta_number_full" | sed 's/b//')
          padded_beta_number=$(printf "%03d" "$beta_number")
          android_numeric_patch_part="${patch_base}${padded_beta_number}"
          echo "android_fversion_for_consts=$android_numeric_patch_part" >> $GITHUB_OUTPUT

      - name: Bump version to ${{ github.event.inputs.fversion }}
        continue-on-error: true
        run: |
          sed -i '0,/PROJECT_VERSION = "\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)\(-[a-z0-9]*\)*"/s//PROJECT_VERSION = "\1.\2.${{ steps.prepare_version.outputs.android_fversion_for_consts }}"/' ./deps/ledfx/ledfx/consts.py
          new_version=$(sed -n 's/.*PROJECT_VERSION = "\([0-9]*\.[0-9]*\.[0-9]*\(-[a-z0-9]*\)*\)".*/\1/p' ./deps/ledfx/ledfx/consts.py)
          echo "action_state=$new_version" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Build frontend
        run: |
          cd src3
          yarn
          yarn buildandroid
          cd ..

      - name: Include new build frontend
        run: cp -r ./src3/build ./deps/ledfx/ledfx_frontend

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          architecture: x64
          python-version: 3.12

      - name: Setup Java 17 required by Gradle
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install and upgrade dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip python3-pip autoconf automake libtool pkg-config zlib1g-dev \
            libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade git+https://github.com/kivy/buildozer

      - name: Clean previous Buildozer artifacts
        run: buildozer distclean || echo "distclean failed or nothing to clean, continuing..."
        continue-on-error: true

      - name: Configure Build Architecture for ${{ matrix.arch }}
        run: |
          if [[ "${{ matrix.arch }}" == "universal" ]]; then
            ARCH_CONFIG="arm64-v8a, armeabi-v7a, x86, x86_64"
            echo "Setting buildozer.spec to build for universal: $ARCH_CONFIG"
          else
            ARCH_CONFIG="${{ matrix.arch }}"
            echo "Setting buildozer.spec to build for single arch: $ARCH_CONFIG"
          fi
          sed -i "s/^\(android\.archs\s*=\s*\).*\$/\1$ARCH_CONFIG/" buildozer.spec
          echo "--- buildozer.spec content after modification ---"
          cat buildozer.spec
          echo "-----------------------------------------------"


      - name: Build ${{ matrix.arch }}
        continue-on-error: true
        run: buildozer android debug

      - name: Upload artifact for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.arch }}
          path: ./bin/*.apk

      # - name: Upload compiled distribution for ${{ matrix.arch }}
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dist-${{ matrix.arch }}
      #     path: .buildozer/android/platform/build-${{ matrix.arch }}/dists/ledfx/

  build_archs_release:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        arch: [armeabi-v7a, arm64-v8a]

    steps:
      - name: Checkout Android Builder
        uses: actions/checkout@v4
        with:
          repository: YeonV/ledfx-android
      - name: Checkout LedFx Core
        uses: actions/checkout@v4
        with:
          repository:  ${{ github.event.inputs.ledfx_core_repo }}
          path: deps/ledfx
          ref: ${{ github.event.inputs.ledfx_core_ref }}
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: YeonV/LedFx-Frontend-v2
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src3
      - name: Check out tools from GitHub
        uses: actions/checkout@v4
        with:
          repository: YeonV/LedFx-Builds
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src2

      - name: Delete old frontend
        uses: JesseTG/rm@2fb8f3b8a0e41fc222e7943b63306c602feb187e
        with:
          path: ./deps/ledfx/ledfx_frontend

      - name: apply patches
        run: |
          cp ./src2/tools/sentry.patch ./deps/ledfx/sentry.patch
          cd ./deps/ledfx
          git apply sentry.patch
          cd ../..

      - name: Prepare version Bump for Android
        id: prepare_version
        run: |
          raw_fversion="${{ github.event.inputs.fversion }}"
          patch_base=$(echo "$raw_fversion" | cut -d'-' -f1)
          beta_number_full=$(echo "$raw_fversion" | cut -d'-' -f2)
          beta_number=$(echo "$beta_number_full" | sed 's/b//')
          padded_beta_number=$(printf "%03d" "$beta_number")
          android_numeric_patch_part="${patch_base}${padded_beta_number}"
          echo "android_fversion_for_consts=$android_numeric_patch_part" >> $GITHUB_OUTPUT

      - name: Bump version to ${{ github.event.inputs.fversion }}
        continue-on-error: true
        run: |
          sed -i '0,/PROJECT_VERSION = "\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)\(-[a-z0-9]*\)*"/s//PROJECT_VERSION = "\1.\2.${{ steps.prepare_version.outputs.android_fversion_for_consts }}"/' ./deps/ledfx/ledfx/consts.py
          new_version=$(sed -n 's/.*PROJECT_VERSION = "\([0-9]*\.[0-9]*\.[0-9]*\(-[a-z0-9]*\)*\)".*/\1/p' ./deps/ledfx/ledfx/consts.py)
          echo "action_state=$new_version" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Build frontend
        run: |
          cd src3
          yarn
          yarn buildandroid
          cd ..

      - name: Include new build frontend
        run: cp -r ./src3/build ./deps/ledfx/ledfx_frontend

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          architecture: x64
          python-version: 3.12

      - name: Setup Java 17 required by Gradle
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install and upgrade dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip python3-pip autoconf automake libtool pkg-config zlib1g-dev \
            libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade git+https://github.com/kivy/buildozer

      - name: Clean previous Buildozer artifacts
        run: buildozer distclean || echo "distclean failed or nothing to clean, continuing..."
        continue-on-error: true

      - name: Configure Build Architecture for ${{ matrix.arch }}
        run: |
          ARCH_CONFIG="${{ matrix.arch }}"
          echo "Setting buildozer.spec to build for single arch: $ARCH_CONFIG"
          sed -i "s/^\(android\.archs\s*=\s*\).*\$/\1$ARCH_CONFIG/" buildozer.spec
          echo "--- buildozer.spec content after modification ---"
          cat buildozer.spec
          echo "-----------------------------------------------"

      - name: Build Release ${{ matrix.arch }}
        continue-on-error: true
        run: buildozer android release

      - name: Decode keystore from secrets
        continue-on-error: true
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_LEDFX_BASE64 }}" | base64 -d > $RUNNER_TEMP/ledfx-keystore.jks
          echo "✅ Keystore decoded successfully"

      - name: Sign APK with apksigner
        continue-on-error: true
        run: |
          # Find apksigner
          APKSIGNER=$(find $ANDROID_HOME/build-tools -name "apksigner" | sort -r | head -n 1)
          echo "Using apksigner at: $APKSIGNER"
          
          # Sign the APK
          APK_FILE=$(ls ./bin/*.apk)
          echo "Signing: $APK_FILE"
          $APKSIGNER sign --ks $RUNNER_TEMP/ledfx-keystore.jks \
            --ks-pass pass:${{ secrets.ANDROID_KEYSTORE_LEDFX_PASSWORD }} \
            --key-pass pass:${{ secrets.ANDROID_KEYSTORE_LEDFX_PASSWORD }} \
            --ks-key-alias ${{ secrets.ANDROID_KEYSTORE_LEDFX_ALIAS }} \
            "$APK_FILE"
          
          # Verify the signature
          $APKSIGNER verify "$APK_FILE"
          echo "✅ APK signed successfully with production keystore"

      - name: Upload release artifact for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: package-release-${{ matrix.arch }}
          path: ./bin/*.apk

  # build_universal:
  #   name: Package Universal APK
  #   runs-on: ubuntu-22.04
  #   needs: build_archs # This job starts only after all arch builds are done
  #   steps:
  #     # We need to check out the code again for the buildozer.spec file
  #     - name: Checkout Android Builder
  #       uses: actions/checkout@v4
  #       with:
  #         repository: YeonV/ledfx-android

  #     # Setup is minimal, no need to build the frontend again
  #     - name: Setup Java 17 and other dependencies
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'
  #     - name: Install Buildozer
  #       run: |
  #         sudo apt-get update && sudo apt-get install -y python3-pip
  #         python3 -m pip install --upgrade pip
  #         python3 -m pip install --upgrade git+https://github.com/kivy/buildozer

  #     # --- NEW STEP: Download all the distributions ---
  #     - name: Download all compiled distributions
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: dists/
  #         pattern: dist-*
  #         merge-multiple: true

  #     - name: Prepare Buildozer directories
  #       run: |
  #         echo "--- Verifying downloaded artifact structure ---"
  #         ls -R dists/
  #         echo "---------------------------------------------"

  #         echo "Recreating directory structure for universal build..."
  #         # This is the destination p4a will look for multi-arch distributions
  #         DEST_DIR=".buildozer/android/platform/build-arm64-v8a_armeabi-v7a_x86_x86_64/dists/"
  #         mkdir -p "$DEST_DIR"

  #         echo "Renaming and moving downloaded distributions..."
  #         
  #         # Use 'find' to robustly locate the source 'ledfx' directories
  #         find dists -mindepth 2 -maxdepth 2 -type d -name ledfx | while read -r src_dist_path; do
  #           # Extract the arch from the parent directory name 
  #           # e.g., 'dists/dist-arm64-v8a/ledfx' -> 'arm64-v8a'
  #           arch=$(echo "$src_dist_path" | cut -d'-' -f2 | cut -d'/' -f1)

  #           # The destination path needs the p4a suffix format for multi-arch builds
  #           dest_dist_path="$DEST_DIR/ledfx__$arch"
  #           
  #           echo "Moving '$src_dist_path' to '$dest_dist_path'"
  #           mv "$src_dist_path" "$dest_dist_path"
  #         done
  #         
  #         echo "--- Final distributions ready for packaging ---"
  #         ls -l "$DEST_DIR"
  #         echo "---------------------------------------------"

  #     - name: Configure buildozer.spec for universal build
  #       run: |
  #         ARCH_CONFIG="arm64-v8a, armeabi-v7a, x86, x86_64"
  #         sed -i "s/^\(android\.archs\s*=\s*\).*\$/\1$ARCH_CONFIG/" buildozer.spec

  #     - name: Package universal APK using existing distributions
  #       continue-on-error: true
  #       run: |
  #         # The standard 'debug' command will find the pre-compiled distributions
  #         # and skip the compilation, proceeding directly to APK packaging.
  #         buildozer -v android debug

  #     - name: Upload universal APK
  #       continue-on-error: true
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: package-universal
  #         path: ./bin/*.apk

  release:
    if: ${{ always() && github.event.inputs.release == 'Yes' && github.event.inputs.upload_url != '' }}
    runs-on: ubuntu-22.04
    needs: [build_archs, build_archs_release] # build_universal
    permissions:
      contents: write
    steps:
      - name: Download all APK artifacts
        uses: actions/download-artifact@v4
        with:
          path: apks/
          pattern: package-*
          merge-multiple: true

      - name: List downloaded files
        run: ls -R apks/

      - name: Extract release tag from upload URL
        id: extract_tag
        run: |
          # Extract tag from upload URL like: https://uploads.github.com/repos/OWNER/REPO/releases/ID/assets{?name,label}
          # We need to get the release ID and then query for the tag
          RELEASE_ID=$(echo "${{ github.event.inputs.upload_url }}" | sed -n 's/.*\/releases\/\([0-9]*\)\/.*/\1/p')
          echo "Release ID: $RELEASE_ID"
          
          # Get the tag name from the release
          TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" | \
            jq -r '.tag_name')
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Extracted tag: $TAG"

      - name: Upload all APKs to Release
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for apk_file in apks/*.apk; do
            if [ -f "$apk_file" ]; then
              # Buildozer names the file with arch, e.g., 'ledfx-version-arm64-v8a-debug.apk'
              # We parse the arch from the filename for the asset name.
              arch=$(echo "$(basename "$apk_file")" | sed -n 's/.*-\(armeabi-v7a\|arm64-v8a\|x86_64\|x86\)-.*/\1/p')

              # If arch isn't in the filename (the universal build), default to 'universal'.
              if [ -z "$arch" ]; then
                arch="universal"
              fi
              
              # Detect if this is a release build by checking the filename
              if [[ "$apk_file" == *"release"* ]]; then
                asset_name="LedFx_CC-v2.1.${{ github.event.inputs.fversion }}--android-${arch}-release.apk"
              else
                asset_name="LedFx_CC-v2.1.${{ github.event.inputs.fversion }}--android-${arch}.apk"
              fi
              
              echo "Uploading $apk_file as $asset_name"

              # Clean the upload URL by removing the template suffix
              UPLOAD_URL=$(echo "${{ github.event.inputs.upload_url }}" | sed 's/{?name,label}//')
              
              # Using curl to upload directly to the release
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/vnd.android.package-archive" \
                --data-binary @"$apk_file" \
                "${UPLOAD_URL}?name=${asset_name}"
            fi
          done