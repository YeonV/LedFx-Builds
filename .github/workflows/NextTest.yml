name: Release Test

on:
  workflow_dispatch:
    inputs:
      fversion:
       description: 'Frontend Version'
       default: '87'
       required: false
      portaudio:
       description: 'Build Portaudio | Sorry you need to write true to enable'
       default: 'No'
       required: false
       type: choice
       options:
         - 'Yes'
         - 'No'

jobs:
  createrelease:
    name: Create Release
    runs-on: [ubuntu-latest]
    steps:    
    - name: Get latest frontend
      run: |
        curl -L --max-redirs 10 -o ledfx_frontend_v2.zip "https://github.com/YeonV/LedFx-Frontend-v2/releases/latest/download/ledfx_frontend_v2.zip"
    - name: Save Frontend for publish
      uses: actions/upload-artifact@v3
      with:
        name: ledfx_frontend_v2
        path: ledfx_frontend_v2.zip     
    - name: Get Messages
      run: |
        unzip -p ledfx_frontend_v2.zip ledfx_frontend_v2/messages.md >message.md
        echo "## New LedFx binaries available:

        ### Core:  -- Browser-Based
        ### Client:   -- Desktop-App (needs a running Core)
        ### CC:  -- Desktop-App (Core-integrated)

        ---

        ##  More informations regarding Core, Client and CC:

        <details><summary>expand</summary>

        #### Core
        If you don't know where to start, get this, open an internet browser, go to https://localhost:8888/ and off you go.
        This is the server/backend that takes in audio, does the calculations and outputs blinking lights. Runs in the background on a Windows/Mac/Linux computer. You can then open the frontend in an internet browser, by going to https://localhost:8888/ on the same computer that is running the Core.
        You can also pull up the frontend on your smartphone (or any other computer on the same network) by finding out what local IP your computer running the Core uses (most likely something like this 192.168.1.XXX, or 192.168.0.XXX) and opening a Browser on your smartphone and going to eg. https://192.168.1.123:8888/


        #### Client
        This is a Desktop App that opens the frontend of LedFx in a window on your desktop.
        This app does NOT include the LedFx backend/server and cannot run LedFx by itself without the Core.
        This Client app is useful for connecting to a running Core on your network (or the same machine).

        ### CC (Client + Core = CC)
        This is the Client and Core integrated into one Desktop App.
        This Desktop App opens the Client frontend of LedFx in a window on your desktop AND runs the Core backend/server in the background.
        This is useful for people who want the whole LedFx experience in one nice and tidy package.
        With this, you can still connect to the backend server via a Client or browser.

        </details>

        ---

        ## ⚠️ These builds are not signed  (read this please):

        <details><summary>Mac-Users:</summary>

        #### Infos:
        Reports as damaged, because of unsiged.
        To fix it open Terminal and type in the following (with a SPACE at the end):
        
        <code>sudo xattr -cr </code>
        
        Then drag'n'drop the LedFx.app File into the terminal and hit enter -> it should ask for sudo password

        Now you can open the App normally, give microphone and network permission, and you can even drag it into your applications.
        Maybe at some point we might buy an apple dev-license for 99€/year, then the voodoo would not be needed anymore.

        </details>


        <details><summary>Win-Users:</summary>

        #### Infos:
        Reports as unsave, because of unsiged.

        Maybe at some point we might buy a microsoft dev-license

        </details>
        " >> ../messages.md
        
    - uses: actions/checkout@v3
      with:
        repository: YeonV/LedFx-Frontend-v2
        ref: main
        path: frontend        
        fetch-depth: 0
        
    - name: Get frontend Changelog
      run: |
        cd frontend
        git log --pretty=format:"+ %s [![by](https://img.shields.io/badge/by-$(echo '%an' | sed 's/ /_/g')-blue.svg?logo=github&logoColor=white)](https://github.com/LedFx/LedFx/commit/%h)" $(git describe --tags --abbrev=0 @^)..@ | grep -v -E '(cleanup)' | awk '{ sub(/\[\[!\]\]/, ""); msg = substr($0, 1, index($0, "[!") - 1); if (length(msg) >= 5 && !seen[msg]++) { print $0 } }' | awk '{ while (match($0, /https:\/\/img\.shields\.io\/badge\/by-[^"]*-blue\.svg\?logo=github&logoColor=white/)) { url = substr($0, RSTART, RLENGTH); gsub(" ", "_", url); printf "%s%s", substr($0, 1, RSTART - 1), url; $0 = substr($0, RSTART + RLENGTH) } gsub(" ", "_", $0); print }'  
        echo "
        ### Frontend-Changes:
        " >> ../messages.md
        git log --pretty=format:"+ %s [![by](https://img.shields.io/badge/by-$(echo '%an' | sed 's/ /_/g')-blue.svg?logo=github&logoColor=white)](https://github.com/LedFx/LedFx/commit/%h)" $(git describe --tags --abbrev=0 @^)..@ | grep -v -E '(cleanup)' | awk '{ sub(/\[\[!\]\]/, ""); msg = substr($0, 1, index($0, "[!") - 1); if (length(msg) >= 5 && !seen[msg]++) { print $0 } }' | awk '{ while (match($0, /https:\/\/img\.shields\.io\/badge\/by-[^"]*-blue\.svg\?logo=github&logoColor=white/)) { url = substr($0, RSTART, RLENGTH); gsub(" ", "_", url); printf "%s%s", substr($0, 1, RSTART - 1), url; $0 = substr($0, RSTART + RLENGTH) } gsub(" ", "_", $0); print }' >> ../messages.md
        cat ../messages.md
    - uses: actions/checkout@v3
      with:
        repository: LedFx/LedFx
        ref: main
        path: backend
        fetch-depth: 0
        
    - name: Get Backend Changelog
      run: |
        cd backend
        git log --pretty=format:"+ %s [![by](https://img.shields.io/badge/by-$(echo '%an' | sed 's/ /_/g')-blue.svg?logo=github&logoColor=white)](https://github.com/LedFx/LedFx/commit/%h)" $(git describe --tags --abbrev=0 @^)..@ | grep -v -E '(cleanup)' | awk '{ sub(/\[\[!\]\]/, ""); msg = substr($0, 1, index($0, "[!") - 1); if (length(msg) >= 5 && !seen[msg]++) { print $0 } }' | awk '{ while (match($0, /https:\/\/img\.shields\.io\/badge\/by-[^"]*-blue\.svg\?logo=github&logoColor=white/)) { url = substr($0, RSTART, RLENGTH); gsub(" ", "_", url); printf "%s%s", substr($0, 1, RSTART - 1), url; $0 = substr($0, RSTART + RLENGTH) } gsub(" ", "_", $0); print }'
        echo "
        ### Backend Changes
        " >> ../messages.md
        git log --pretty=format:"+ %s [![by](https://img.shields.io/badge/by-$(echo '%an' | sed 's/ /_/g')-blue.svg?logo=github&logoColor=white)](https://github.com/LedFx/LedFx/commit/%h)" $(git describe --tags --abbrev=0 @^)..@ | grep -v -E '(cleanup)' | awk '{ sub(/\[\[!\]\]/, ""); msg = substr($0, 1, index($0, "[!") - 1); if (length(msg) >= 5 && !seen[msg]++) { print $0 } }' | awk '{ while (match($0, /https:\/\/img\.shields\.io\/badge\/by-[^"]*-blue\.svg\?logo=github&logoColor=white/)) { url = substr($0, RSTART, RLENGTH); gsub(" ", "_", url); printf "%s%s", substr($0, 1, RSTART - 1), url; $0 = substr($0, RSTART + RLENGTH) } gsub(" ", "_", $0); print }' >> ../messages.md
        cat ../messages.md
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.action_state || '2.0' }}.${{ github.event.inputs.fversion }}-beta
        #tag_name: v2.0.${{ github.event.inputs.fversion }}
        release_name: Release v${{ env.action_state || '2.0'}}.${{ github.event.inputs.fversion }}-beta
        body_path: ./messages.md
        draft: false
        prerelease: true
    - name: Output Release URL File
      run: echo "${{ steps.create_release.outputs.upload_url }}" > release_url.txt
    - name: Save Release URL File for publish
      uses: actions/upload-artifact@v3
      with:
        name: release_url
        path: release_url.txt


        
  build:
    needs: createrelease
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash -x {0}
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ['3.12.x']
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4
        with:
          repository: LedFx/LedFx
          ref: main
          path: src

      - uses: actions/checkout@v3
        name: Check out tools from GitHub
        with:
          repository: YeonV/LedFx-Builds
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: src2
      - name: Delete old frontend
        uses: JesseTG/rm@v1.0.3
        with:
          path: ./src/ledfx_frontend
      - name: get git version
        run: |        
          cd src
          git rev-parse HEAD >> ledfx/git_version
          cd ..
      - name: Get latest frontend
        run: |
          curl -L --max-redirs 10 -o ledfx_frontend_v2.zip "https://github.com/YeonV/LedFx-Frontend-v2/releases/latest/download/ledfx_frontend_v2.zip"
      - name: Include new frontend
        if: "!startsWith(matrix.OS, 'win')"  
        run: |
          cd ./ledfx_frontend_v2
          ls
          unzip -o -u ledfx_frontend_v2.zip
          cd ..
          cp -rf ./ledfx_frontend_v2/ledfx_frontend_v2 ./src/ledfx_frontend
          ls ./src/ledfx_frontend

      - name: Include new frontend win    
        if: "startsWith(matrix.OS, 'win')"
        run: |
          unzip ledfx_frontend_v2.zip
          cp -r ./ledfx_frontend_v2 ./src/ledfx_frontend
          ls ./src/ledfx_frontend

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get full Python version
        id: full-python-version
        run: echo version=$(python -c "import sys; print('-'.join(str(v) for v in sys.version_info))") >> $GITHUB_OUTPUT

      - name: Install poetry
        run: |
          curl -sSL https://install.python-poetry.org | python - -y

      - name: Update Path for Windows
        run: echo "$APPDATA\Python\Scripts" >> $GITHUB_PATH

      - name: Enable long paths for git on Windows
        run: git config --system core.longpaths true

      - name: Configure poetry
        run: poetry config virtualenvs.in-project true

      - name: Get pip cache dir
        id: pip-cache
        run: |
          echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT
          echo "dir=$(pip cache dir)"
      - name: pip cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Bump version    
        if: "startsWith(matrix.OS, 'win') || startsWith(matrix.OS, 'ubu')"  
        run: |
          sed -i 's/\(PROJECT_VERSION = "[0-9]*\.[0-9]*\.\)[0-9]*"/\1${{ github.event.inputs.fversion }}"/' ./src/ledfx/consts.py
          sed -i 's/\(version = "[0-9]*\.[0-9]*\.\)[0-9]*"/\1${{ github.event.inputs.fversion }}"/' ./src/pyproject.toml
          
      - name: Bump version osx
        if: "!startsWith(matrix.OS, 'win') && !startsWith(matrix.OS, 'ubu')"  
        run: |
          brew install gnu-sed
          gsed -i 's/\bPROJECT_VERSION = "[0-9]*\.[0-9]*\.\)[0-9]*"/\1${{ github.event.inputs.fversion }}"/' ./src/ledfx/consts.py
          gsed -i 's/\b(version = "[0-9]*\.[0-9]*\.\)[0-9]*"/\1${{ github.event.inputs.fversion }}"/' ./src/pyproject.toml
          
      - name: Check lock file
        run: |
          cd src
          poetry check --lock

      - name: Build a binary wheel
        run: |        
          cd src
          poetry build

      - name: Install LedFx
        run: |
          cd src
          poetry install          
          poetry env info
          echo "poetry_venv_location=$(poetry env info --path)" >> $GITHUB_ENV
          poetry run ledfx-loopback-install
          poetry run pip install pyinstaller

      - name: Get Backend Version and poetry-venv-path
        id: getbackendver
        run: |
          cd src
          poetry run ledfx --version | cut -d' '
          echo "action_state=$(poetry run ledfx --version | cut -d' ' -f2| cut -d. -f1,2).${{ github.event.inputs.fversion }}" >> $GITHUB_ENV
          BINARY_NAME=LedFx_core-
          echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_ENV
          echo $action_state
          echo $BINARY_NAME
          echo $poetry_venv_location

      - name: Portaudio dependency for windows
        if: startsWith(runner.os, 'Windows') && github.event.inputs.portaudio == 'true'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: |
              git
              zip
              unzip
              base-devel
              mingw-w64-x86_64-gcc
              mingw-w64-x86_64-cmake
              mingw-w64-x86_64-ninja

      - name: Build portaudio
        if: startsWith(runner.os, 'Windows') && github.event.inputs.portaudio == 'true'
        shell: msys2 {0}
        run: |
          export CYGPATH=$(cygpath -m /)
          git clone https://github.com/portaudio/portaudio
          cmake -B portaudio/.build -S portaudio -DCMAKE_INSTALL_PREFIX=${MINGW_PREFIX} -DPA_BUILD_SHARED_LIBS=on -DCMAKE_BUILD_TYPE=Release -DPA_USE_ASIO=on
          cmake --build portaudio/.build/
          cmake --install portaudio/.build/
          rm -rf portaudio
          mv $CYGPATH/mingw64/bin/libportaudio.dll $poetry_venv_location/lib/site-packages/_sounddevice_data/portaudio-binaries/libportaudio64bit.dll

      - name: Build ${{ env.BINARY_NAME }} ${{ env.action_state }}
        if: startsWith(runner.os, 'Windows')
        run: |
          mv src2/tools/win/hook-samplerate.py $poetry_venv_location/lib/site-packages/_pyinstaller_hooks_contrib/hooks/stdhooks/hook-samplerate.py
          cd src
          poetry run pyinstaller win.spec
          mv dist/LedFx $BINARY_NAME-v$action_state
          7z.exe a -tzip $BINARY_NAME-v$action_state--win.zip $BINARY_NAME-v$action_state "-mx5" "-xr!.git" "-xr!.github"

      - name: Upload ${{ env.BINARY_NAME }} core ${{ env.action_state }}
        if: startsWith(runner.os, 'Windows')
        uses: actions/upload-artifact@v3
        with:
            name: ${{ env.BINARY_NAME }}-v${{ env.action_state }}--win.zip
            path: src/${{ env.BINARY_NAME }}-v${{ env.action_state }}--win.zip

      - name: Build ${{ env.BINARY_NAME }} portable ${{ env.action_state }}
        if: startsWith(runner.os, 'Windows')
        run: |
            cp src2/tools/win/yzwin.spec ./src/win-portable.spec
            cd src
            poetry run pyinstaller win-portable.spec
            ls dist/
            mv dist/LedFx.exe dist/$BINARY_NAME-v$action_state--win-portable.exe


      - name: Upload ${{ env.BINARY_NAME }} portable ${{ env.action_state }}
        if: startsWith(runner.os, 'Windows')
        uses: actions/upload-artifact@v3
        with:
            name: ${{ env.BINARY_NAME }}-v${{ env.action_state }}--win-portable.exe
            path: src\dist\${{ env.BINARY_NAME }}-v${{ env.action_state }}--win-portable.exe
